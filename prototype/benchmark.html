<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Performance Benchmark Runner</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 2rem;
      background: #f5f5f5;
    }
    h1 { color: #333; }
    .benchmark-card {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin: 1rem 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .metric {
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 4px;
    }
    .metric-label {
      font-size: 0.875rem;
      color: #666;
      margin-bottom: 0.25rem;
    }
    .metric-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #333;
    }
    .metric-unit {
      font-size: 0.875rem;
      color: #999;
    }
    button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      margin-right: 0.5rem;
    }
    button:hover {
      background: #0052a3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      padding: 1rem;
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 4px;
      margin: 1rem 0;
    }
    .results {
      background: #e7f3ff;
      border: 1px solid #0066cc;
      padding: 1rem;
      border-radius: 4px;
      margin-top: 1rem;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
      font-size: 0.875rem;
    }
  </style>
</head>
<body>
  <h1>📊 PDF Editor Performance Benchmarks</h1>

  <div class="benchmark-card">
    <h2>Test Suite</h2>
    <p>This page runs automated benchmarks on test PDFs and displays results.</p>

    <div id="status" class="status">
      Ready to run benchmarks. Click "Run All Tests" to start.
    </div>

    <button id="runAll">Run All Tests</button>
    <button id="exportResults">Export Results (Markdown)</button>
  </div>

  <div id="test-150" class="benchmark-card" style="display:none;">
    <h3>Test 1: Small PDF (150 pages, ~0.11 MB)</h3>
    <div class="metrics" id="metrics-150"></div>
  </div>

  <div id="test-500" class="benchmark-card" style="display:none;">
    <h3>Test 2: Medium PDF (500 pages, ~0.66 MB)</h3>
    <div class="metrics" id="metrics-500"></div>
  </div>

  <div id="results-container" style="display:none;">
    <div class="benchmark-card">
      <h3>Markdown Results</h3>
      <div id="markdown-results" class="results"></div>
    </div>
  </div>

  <script src="vendor-loader.js"></script>
  <script>
    const testFiles = [
      { name: 'test-150pages.pdf', label: 'Small PDF (150 pages)', id: '150' },
      { name: 'test-500pages.pdf', label: 'Medium PDF (500 pages)', id: '500' }
    ];

    const allResults = [];
    let pdfDoc = null;

    // Wait for vendor assets to load
    window.addEventListener('vendorAssetsLoaded', async () => {
      if (window['pdfjsLib']) {
        const workerSrc = (window.PDF_ASSETS && window.PDF_ASSETS.pdfWorker) ||
          'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.worker.min.js';
        pdfjsLib.GlobalWorkerOptions.workerSrc = workerSrc;
      }
    });

    async function runBenchmark(testFile) {
      const status = document.getElementById('status');
      status.textContent = `Running: ${testFile.label}...`;

      const perfMetrics = {
        fileLoadStart: 0,
        fileLoadEnd: 0,
        renderStart: 0,
        thumbnailsComplete: 0,
        pagesComplete: 0,
        renderEnd: 0
      };

      try {
        // Load PDF
        perfMetrics.fileLoadStart = performance.now();
        const response = await fetch(testFile.name);
        const arrayBuffer = await response.arrayBuffer();
        const fileSize = arrayBuffer.byteLength;

        const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
        pdfDoc = await loadingTask.promise;
        perfMetrics.fileLoadEnd = performance.now();

        const pageCount = pdfDoc.numPages;

        // Render thumbnails
        perfMetrics.renderStart = performance.now();
        for (let i = 1; i <= Math.min(pageCount, 10); i++) {
          const page = await pdfDoc.getPage(i);
          const viewport = page.getViewport({ scale: 0.25 });
          const canvas = document.createElement('canvas');
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          const ctx = canvas.getContext('2d');
          await page.render({ canvasContext: ctx, viewport }).promise;
        }
        perfMetrics.thumbnailsComplete = performance.now();

        // Render full pages (first 5 only for speed)
        for (let i = 1; i <= Math.min(pageCount, 5); i++) {
          const page = await pdfDoc.getPage(i);
          const viewport = page.getViewport({ scale: 1.5 });
          const canvas = document.createElement('canvas');
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          const ctx = canvas.getContext('2d');
          await page.render({ canvasContext: ctx, viewport }).promise;
        }
        perfMetrics.pagesComplete = performance.now();
        perfMetrics.renderEnd = performance.now();

        // Calculate metrics
        const fileSizeMB = (fileSize / (1024 * 1024)).toFixed(2);
        const loadTime = Math.round(perfMetrics.fileLoadEnd - perfMetrics.fileLoadStart);
        const thumbnailTime = Math.round(perfMetrics.thumbnailsComplete - perfMetrics.renderStart);
        const pageRenderTime = Math.round(perfMetrics.pagesComplete - perfMetrics.thumbnailsComplete);
        const totalRenderTime = Math.round(perfMetrics.renderEnd - perfMetrics.renderStart);
        const memUsage = performance.memory ? (performance.memory.usedJSHeapSize / (1024 * 1024)).toFixed(2) : 'N/A';

        const result = {
          name: testFile.label,
          pages: pageCount,
          fileSize: fileSizeMB,
          loadTime,
          thumbnailTime,
          pageRenderTime,
          totalRenderTime,
          memUsage
        };

        allResults.push(result);
        displayMetrics(testFile.id, result);

        return result;
      } catch (err) {
        status.textContent = `Error: ${err.message}`;
        console.error(err);
        throw err;
      }
    }

    function displayMetrics(testId, result) {
      const container = document.getElementById(`test-${testId}`);
      container.style.display = 'block';

      const metricsEl = document.getElementById(`metrics-${testId}`);
      metricsEl.innerHTML = `
        <div class="metric">
          <div class="metric-label">File Size</div>
          <div class="metric-value">${result.fileSize} <span class="metric-unit">MB</span></div>
        </div>
        <div class="metric">
          <div class="metric-label">Pages</div>
          <div class="metric-value">${result.pages} <span class="metric-unit">pages</span></div>
        </div>
        <div class="metric">
          <div class="metric-label">Load Time</div>
          <div class="metric-value">${result.loadTime} <span class="metric-unit">ms</span></div>
        </div>
        <div class="metric">
          <div class="metric-label">Thumbnail Render</div>
          <div class="metric-value">${result.thumbnailTime} <span class="metric-unit">ms</span></div>
        </div>
        <div class="metric">
          <div class="metric-label">Page Render (5 pages)</div>
          <div class="metric-value">${result.pageRenderTime} <span class="metric-unit">ms</span></div>
        </div>
        <div class="metric">
          <div class="metric-label">Total Render Time</div>
          <div class="metric-value">${result.totalRenderTime} <span class="metric-unit">ms</span></div>
        </div>
        <div class="metric">
          <div class="metric-label">Memory Usage</div>
          <div class="metric-value">${result.memUsage} <span class="metric-unit">MB</span></div>
        </div>
      `;
    }

    function generateMarkdown() {
      const timestamp = new Date().toLocaleString();
      const browser = navigator.userAgent.match(/(Chrome|Firefox|Safari|Edge)\/[\d.]+/)?.[0] || 'Unknown';

      let md = `# Performance Benchmark Results\n\n`;
      md += `**Date:** ${timestamp}\n`;
      md += `**Browser:** ${browser}\n`;
      md += `**Engine:** pdf.js 2.16.105 + pdf-lib 1.17.1\n\n`;

      md += `## Small PDF (150 pages, ~0.11 MB)\n\n`;
      if (allResults[0]) {
        const r = allResults[0];
        md += `| Metric | Value | Target | Status |\n`;
        md += `|--------|-------|--------|--------|\n`;
        md += `| Load Time | ${r.loadTime} ms | < 2000 ms | ${r.loadTime < 2000 ? '✅ Pass' : '❌ Fail'} |\n`;
        md += `| Render Time (total) | ${r.totalRenderTime} ms | < 3000 ms | ${r.totalRenderTime < 3000 ? '✅ Pass' : '❌ Fail'} |\n`;
        md += `| Memory Usage | ${r.memUsage} MB | < 200 MB | ${r.memUsage !== 'N/A' && parseFloat(r.memUsage) < 200 ? '✅ Pass' : '❌ Fail'} |\n\n`;
      }

      md += `## Medium PDF (500 pages, ~0.66 MB)\n\n`;
      if (allResults[1]) {
        const r = allResults[1];
        md += `| Metric | Value | Target | Status |\n`;
        md += `|--------|-------|--------|--------|\n`;
        md += `| Load Time | ${r.loadTime} ms | < 3000 ms | ${r.loadTime < 3000 ? '✅ Pass' : '❌ Fail'} |\n`;
        md += `| Render Time (total) | ${r.totalRenderTime} ms | < 5000 ms | ${r.totalRenderTime < 5000 ? '✅ Pass' : '❌ Fail'} |\n`;
        md += `| Memory Usage | ${r.memUsage} MB | < 300 MB | ${r.memUsage !== 'N/A' && parseFloat(r.memUsage) < 300 ? '✅ Pass' : '❌ Fail'} |\n\n`;
      }

      return md;
    }

    document.getElementById('runAll').addEventListener('click', async () => {
      const btn = document.getElementById('runAll');
      btn.disabled = true;
      allResults.length = 0;

      for (const testFile of testFiles) {
        await runBenchmark(testFile);
        await new Promise(resolve => setTimeout(resolve, 1000)); // Cool down
      }

      document.getElementById('status').textContent = 'All tests complete!';
      btn.disabled = false;
      document.getElementById('exportResults').disabled = false;
    });

    document.getElementById('exportResults').addEventListener('click', () => {
      const markdown = generateMarkdown();
      document.getElementById('results-container').style.display = 'block';
      document.getElementById('markdown-results').textContent = markdown;

      // Scroll to results
      document.getElementById('results-container').scrollIntoView({ behavior: 'smooth' });
    });
  </script>
</body>
</html>
